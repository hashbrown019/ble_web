<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!--
		Customize this policy to fit your own app's needs. For more guidance, please refer to the docs:
			https://cordova.apache.org/docs/en/latest/
		Some notes:
			* https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
			* Disables use of inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
				* Enable inline JS: add 'unsafe-inline' to default-src
		-->
		<meta name="format-detection" content="telephone=no">
		<!-- <meta http-equiv="Content-Security-Policy" content="img-src * data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval';"> -->
		<meta name="msapplication-tap-highlight" content="no">
		<!-- <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover"> -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"> -->
		<meta name="format-detection" content="telephone=no">
		<meta name="msapplication-tap-highlight" content="no">
		<meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
		<!-- <meta name="color-scheme" content="light dark"> -->
		<!-- <link rel="stylesheet" href="css/index.css"> -->
		<link rel="stylesheet" href="https://crisnotbrown.pythonanywhere.com/static/_test_/css/x.css">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
		crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
		crossorigin=""></script>
		<script src="https://crisnotbrown.pythonanywhere.com/static/_test_/js/Brorn.min.js"></script>
		<script src="https://crisnotbrown.pythonanywhere.com/static/_test_/js/trilateration.js"></script>
		<script src="https://crisnotbrown.pythonanywhere.com/static/_test_/js/index.js"></script>
		<title>BLE Scanner FSUU</title>
		<style type="text/css">
			body {
				padding: 0;
				margin: 0;
			}
			html, body, #map {
				height: 80%;
				width: 100vw;
			}
			.view-button_ {
					background: #fff;
				border-radius: 4px;
				border: none;
				box-sizing: border-box;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
				color: rgba(0, 0, 0, 0.8);
				display: block;
				font-family: Futura, Helvetica Neue, sans-serif;
				font-size: 12px;
				font-weight: 700;
				max-width: 128px;
				overflow-wrap: break-word;
				padding: 0.5em 1em;
				position: absolute;
				width: max-content;
				height: max-content;
				transform: translate3d(-50%, -50%, 0);
				}
		</style>
		<script type="module" src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
		<!-- <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script> -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body style="background-image: url('https://crisnotbrown.pythonanywhere.com/static/_test_/img/bg.jpg');">
		<!-- http://127.0.0.1:5000 -->
		<header class="x-header x-teal">
			<div class="x-container">
				<img onclick="stop_all_scan()" src="https://crisnotbrown.pythonanywhere.com/static/_test_/img/2.png" class="x-img x-left" style="max-width: 22%;"><br>
				<!-- <img onclick="stop_all_scan()" src="https://crisnotbrown.pythonanywhere.com/static/_test_/img/barcode-scan.gif" class="x-img x-left" style="max-width: 20%;"><br> -->
				<div class="x-container x-right">
					<b class="x-large x-text-orange">
						<u>BLE Beacon Locator</u><br>
						<span class="x-tiny x-text-white x-right">for navigation inside FSUU</span>
					</b>
				</div>
			</div>
		</header>

		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->
		<!-- ====================================================================== -->

		<model-viewer 
			id = "floor_plan"
			class ="view x-display-container"
			src="https://crisnotbrown.pythonanywhere.com/static/_test_/assets/floor/1.glb"
			alt="FSUU main Campus"
			camera-controls
			disable-zoom disable-tap
			camera-orbit="0deg 0deg 0m"
			style ="width: 100vw;height: 90vh;"
			>
				<button
					class="x-btn x-circle" 
					id="pppp_s"
					latitude = "8.948083"
					longitude =  "125.541828"
					slot="hotspot-button"
					data-position="-6.552631579232208 0.3 5.368421052634026"
					>
					<span class="x-text-green x-circle x-blue x-text-white fa fa-user-circle-o x-fading"></span>
				</button>

				<!-- <span
					class="x-btn x-circle" 
					id="lllll"
					latitude = "8.948083"
					longitude =  "125.541828"
					slot="hotspot-center"
					data-position="0.0 0.3 0.0"
					>
					x
				</span> -->
			{% set count=1%}
			{% for bec in beacons %}
				<span
					class="view-button floors x-left floor_{{bec['f_floor']}} x-center x-round-xlarge" 
					id="{{bec['f_code']}}"
					latitude = "8.948083"
					longitude =  "125.541828"
					slot="hotspot-{{ loop.index }}"
					data-position="{{bec['f_x']}} {{bec['f_y']}} {{bec['f_z']}}"
					onclick = 'get_direction(this)'
					>
					<b class="x-tiny">{{bec['f_name']}}</b> <br>
					<!-- <i class="x-tiny">{{bec['f_description']}}</i><br> -->
					<span class="fa fa-bullseye"></span>
				</span>
			{% endfor %}

			{% for path in paths %}
			<button
				class="path x-btn x-circle" 
				slot="hotspot-{{ loop.index + path_len | int}}"
				data-position="{{path['x']}} 0.3 {{path['z']}}"
				>
				<span class="x-text-red x-circle fa fa-circle "></span>
			</button>
			{% endfor %}
			<span class="x-display-topleft x-text-white">Discovered Devices will appear<br> on the map with approx<br> 10 meters in range</span><br>

			<div class="x-display-topright ">
				<span class="x-tiny x-white x-right">Geo: <span id="data_ble" style="overflow-y:scroll;height: 50vh;"><i>Triangulating...</i></span></span><br>
				<span class="x-tiny x-white x-right">Plane: <span id="data_ble_2" style="overflow-y:scroll;height: 50vh;"><i>Triangulating...</i></span></span><br>
				<span class="x-tiny x-white x-right">Altitude: <span id="data_ble_3" style="overflow-y:scroll;height: 50vh;"><i>Detecting...</i></span></span><br>
				<span class="x-tiny x-white x-right" style="display: none;">Tilt<span id="data_ble_4" style="overflow-y:scroll;height: 50vh;display: none;"><i>Detecting...</i></span></span>
			</div>
			<div class="x-bottom x-container">
				<div class="x-container">
					<b class="x-text-white">Floors</b><br>
					<span class="x-text-white x-tiny">Select a floor manually by clicking the button bellow</span>
				</div>
				<div class="x-row x-container x-center" style="width:100vw">
					<button class="x-padding x-round-large x-border x-border-blue x-hover-black x-col" style="width:15%;" onclick="ch_floor(1)">
						1st Floor
					</button>
					<button class="x-padding x-round-large x-border x-border-blue x-hover-black x-col" style="width:15%;" onclick="ch_floor(2)">
						2nd Floor
					</button>
					<button class="x-padding x-round-large x-border x-border-blue x-hover-black x-col" style="width:15%;" onclick="ch_floor(3)">
						3rd Floor
					</button>
					<button class="x-padding x-round-large x-border x-border-blue x-hover-black x-col" style="width:15%;" onclick="ch_floor(4)">
						4th Floor
					</button>
				</div>
			</div>
		</model-viewer>
		<script type="text/javascript">
		// let DOMAIN = "http://127.0.0.1:5000/"
		// let DOMAIN = "https://crisnotbrown.pythonanywhere.com/"
		let DOMAIN = "http://localhost:5000/"
		// let DOMAIN = "https://192.168.254.123:5000"

		var urios = "8.948083, 125.541828"
		let MY_LONG; let MY_LAT


		const modelViewer = document.querySelector('#floor_plan');

		function getdifcoords(lat,long){
			// diflat = scaleConversion(5/0.00019,null,   lat-8.948083)
			// diflong = scaleConversion(5/0.00019,null, long-125.541828 )
			diflat = scaleConversion(5/0.00011,null,   lat-8.948083)
			diflong = scaleConversion(5/0.00019,null, long-125.541828 )
			MY_LONG = diflong
			MY_LAT = diflat
				modelViewer.updateHotspot({
				name: 'hotspot-button',
				position: diflat+' 0.5 '+ diflong
			});

			
			$ID('data_ble_2').innerHTML = (diflong+"|"+diflat);
			return [diflong,diflat]
		}

		function scaleConversion(scaleFactor, realDimension, scaledDimension) {
			if (scaleFactor <= 0) {return null}
			if (realDimension != null) {
			return realDimension / scaleFactor}
			if (scaledDimension != null) {	return scaledDimension * scaleFactor}
			return null;
		}

		const successCallback = (position) => {
			println("Loc on web "+ JSON.stringify(position))
			getdifcoords(position.coords.latitude, position.coords.longitude);
			$ID('data_ble').innerHTML = (position.coords.latitude+"|"+position.coords.longitude);
			$ID('data_ble_3').innerHTML = (position.coords.altitude);
		};

		const errorCallback = (error) => {
			console.log(error.code, error.message);
		};

		$onload(function(){
			var geo_options = { enableHighAccuracy: true};
			navigator.geolocation.watchPosition(successCallback, errorCallback,geo_options);
			// window.setInterval(function(){
			// 	getdifcoords(8.947936, 125.541991);
			// },1000)
		})

		function get_direction(elem){
			var beacon_ccords_ = elem.getAttribute("data-position")
			$send({
				action : DOMAIN+"get_path_to/"+MY_LAT+"/"+MY_LONG+"/"+beacon_ccords_,
				method: POST,
				func : function(res){
					var resp = JSON.parse(res)
					println("==============")
					for (var i = 0; i < resp.length; i++) {
						if("x" in resp[i] && "z" in resp[i] ){
							if((resp[i]["x"]!= undefined || resp[i]["z"]!= undefined )|| (resp[i]["x"]!= undefined || resp[i]["z"]!= undefined ) ){
								follow(resp[i]["x"],resp[i]["z"])

							}else{
								alert("Error in getting Direction")
							}
						}
					}
				}
			})
		}

		function follow(_x2,_y2){
			const phph = document.querySelectorAll('.path');
			phph.forEach(box => {
				box.remove();
			});

			let x1 = `${MY_LAT}`.split(".")[0];
			let y1 = `${MY_LONG}`.split(".")[0];
			let _x1 = `${MY_LAT}`.split(".")[1];
			let _y1 = `${MY_LONG}`.split(".")[1];
			let x2 = `${_x2}`.split(".")[0];
			let y2 = `${_y2}`.split(".")[0];
			var path_holder = ""
			var loop_count =0
			var is_true = false
			var otherbtn_count = $CLASS("view-button").length
			var temp = 0
			while (x1 != x2 || y1 != y2) {
				// Your code here
				var is_con =false
				var HAAAAA = loop_count+otherbtn_count
				// console.log(`x1: ${x1}, y1: ${y1} ==== x2: ${x2}, y2: ${y2}`);
				if (x1 < x2) {x1++;}
				else if (x1 > x2) {x1--;}
				if (y1 < y2) {y1++;}
				else if (y1 > y2) {y1--;}

				var __paths = $CLASS('path')
				for (var i = 0; i < __paths.length; i++) {
					if(parseInt(__paths[i].getAttribute("slot").split("-")[1])+1==parseInt(HAAAAA)){
						println(parseInt(__paths[i].getAttribute("slot").split("-")[1])+1+"  ==  "+parseInt(HAAAAA))
						println("matched ")
						is_con =false
					}else{
						is_con = true
					}
				}
				if(is_con){
					println("yawaaaaaaassss")
				}else{
					$ID("floor_plan").innerHTML  += (`
					<button
						class="path x-btn x-circle" 
						slot="hotspot-${HAAAAA}"
						data-position="${x1}.${_x1} 0.3 ${y1}.${_y1}"
						>
						<span class="x-text-red x-circle fa fa-circle "></span>
					</button>
					`)
				}
				loop_count+=1

			}

			if(loop_count >=1000 || (x1 !== x2 || y1 !== y2)){
				is_true = false
			}

			// $ID("floor_plan").innerHTML +=path_holder

		}
		// Request the user's location and watch for changes

		</script>
		<div class="x-round-xxlarge view" style="height: 95%;display: none;" id="map"></div>
		<hr>
		<div class="x-row x-container" style="display:none">
			<b>Output Logs</b><br>
			<span class="x-text-grey x-tiny">View Data logs that has been retrieve and gather and error/warning logs</span>
			<div class="x-row">
				<b class="x-text-grey">Data Log</b><br>
				<span id="data_blelogs" class="x-text-grey x-tiny"></span>
				<hr>
				<b class="x-text-grey">Error Log</b><br>
				<span class="x-text-grey x-tiny" id="error_"></span>
				<hr>
				<b class="x-text-grey">Console Log</b><br>
				<span class="x-text-grey x-tiny" id="activity_log"></span>
			</div>        	
		</div>
		<br><br><br>
		<!-- ======================================================= -->
		<script type="text/javascript">
			var coords = []
			var map = L.map('map',{
					minZoom: 15,
					maxZoom: 50
			});
			// var map = L.map('map').setView([8.947894,125.5418056], 21);
			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: 'BLE Scanner | FSUU'
			}).addTo(map);

			$ID('map').querySelectorAll("a")[2].style.display="none"

			document.addEventListener('deviceready', onDeviceReady, false);
			function onDeviceReady() {
				println(" psgrloaded")
				check_if_availble()
				change_view('floor_plan')

			}
			$onload(function(){
				var geo_options = { enableHighAccuracy: true};
					if (window.DeviceMotionEvent == undefined) {
							//No accelerometer is present. Use buttons. 
							alert("no accelerometer");
					}
					else {
							// alert("accelerometer found");
							window.addEventListener("devicemotion", accelerometerUpdate, true);
					}
			})
			function accelerometerUpdate(e) {
				 var aX = event.accelerationIncludingGravity.x*1;
				 var aY = event.accelerationIncludingGravity.y*1;
				 var aZ = event.accelerationIncludingGravity.z*1;
				 //The following two lines are just to calculate a
				 // tilt. Not really needed. 
				 xPosition = Math.atan2(aY, aZ);
				 yPosition = Math.atan2(aX, aZ);
				 println(e)
				 $ID("data_ble_4").innerHTML = ": " +e.accelerationIncludingGravity.x + "|" + e.accelerationIncludingGravity.y + "|" + e.accelerationIncludingGravity.z 
			}


			// samp = {"lat":8.945209,"lng":125.538939}
			// map.setView([samp.lat, samp.lng], 15);

			// map.locate({setView: true})
			// .on('locationfound', function(e){
			//     console.log(e);
			//     $ID("data_ble").innerHTML = "L : " + e.latitude + "| Lg : "+e.longitude
			// });
			// =========================================================================
			
			var points = []
			var FLOOR = $ID("floor_plan")
			FLOOR.addEventListener("click", (event) => {
				const x = event.clientX;
				const y = event.clientY;
				const result = FLOOR.positionAndNormalFromPoint(x, y);
				if (result) {
					const { point, normal } = result;
					println(result)
					points.push([result.position.x, result.position.z])
				}
			});

			function get_clicked() {
				// body...
				println(points)
			}
			// ===================================================================
			// ===================================================================
			// const FLOOR = document.querySelector("#floor_plan");
			const annotationClicked = (annotation) => {
				let dataset = annotation;
				println(dataset)
				FLOOR.cameraTarget = dataset.target;
				FLOOR.cameraOrbit = dataset.orbit;
				FLOOR.fieldOfView = '45deg';
			}

			FLOOR.querySelectorAll('button').forEach((hotspot) => {
				hotspot.addEventListener('click', () => annotationClicked(hotspot));
			});
			// =====================================================================
			// =====================================================================

			function ch_floor(floor){
				println("floor = "+floor)
				FLOOR_SEL = floor
				$ID("floor_plan").src = "https://crisnotbrown.pythonanywhere.com/static/_test_/assets/floor/"+floor+".glb"
				ch_floor_deac(floor)
			}

			function ch_floor_deac(floor){
				var views = $CLASS("floors")
				for (var i = 0; i < views.length; i++) {
					views[i].style.display = "none"
				}
				var views = $CLASS("floor_"+floor)
				for (var i = 0; i < views.length; i++) {
					views[i].style.display = "block"
				}
			}
			ch_floor(1)

			function get_loccation(func){
				navigator.geolocation.getCurrentPosition(function(position) {
						var location ={
							'latlng':[position.coords.latitude,position.coords.longitude],
							'Latitude':position.coords.latitude,
							'Longitude':position.coords.longitude,
							'Altitude':position.coords.altitude,
							'Accuracy':position.coords.accuracy,
							'Altitude Accuracy':position.coords.altitudeAccuracy  ,
							'Heading':position.coords.heading,
							'Speed':position.coords.speed,
							'Timestamp':position.timestamp}
							println("setView")
							$ID("activity_log").innerHTML = $ID("activity_log").innerHTML + "Location found in : "+JSON.stringify([position.coords.latitude,position.coords.longitude]) +"<br>"

							map.setView([position.coords.latitude,position.coords.longitude], 21);
							L.marker([position.coords.latitude,position.coords.longitude]).addTo(map)

							func([position.coords.latitude,position.coords.longitude])
							println(location)

					},function (error) {
						alert('code: '    + error.code    + '\n' +
								'message: ' + error.message + '\n');
					});
			}

			function check_if_availble(){
				ble.isEnabled(
					function() {
						$ID("status").innerHTML =("<span class='x-text-green'>Bluetooth is enabled</span>");
						ble_1()
					},
					function() {$ID("status").innerHTML =("<span class='x-text-red'>Bluetooth is *not* enabled</span>"); }
				);
			}

			function change_view(view){
				var views = $CLASS("view")
				for (var i = 0; i < views.length; i++) {
					views[i].style.display = "none"
				}
				$ID(view).style.display = "block"
			}


			function stop_all_scan(){
				$ID("data_ble").innerHTML ="<b class='x-text-yellow x-large'>Please Wait while we stop the current scan</b>"
				setTimeout(ble.stopScan,
					5000,
					function() { $ID("data_ble").innerHTML = ("<span class='x-text-green'>Stop Scan complete</span>"); },
					function() { $ID("data_ble").innerHTML = ("<span class='x-text-red'>stopScan failed</span>"); }
				);
				$ID("data_ble").innerHTML = ("Stop Scan complete");
				get_coords()
				// $ID('data_blelogs').innerHTML = JSON.stringify(coords)
			}

			function refresh(){
				if (map != undefined) { map.remove(); }
				else{
					map = L.map('map',{

							minZoom: 15,
							maxZoom: 50
					});
						// var map = L.map('map').setView([8.947894,125.5418056], 21);
						L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
						attribution: 'BLE Scanner | FSUU'
					}).addTo(map);
				}
				coords = []
				$ID("error_").innerHTML = ""
				$ID("activity_log").innerHTML = ""
				check_if_availble()
				$ID("data_ble").innerHTML = "<b class='x-text-yellow x-large'>Re-scanning, please wait</b>"
				ble_1()
			}


			
			function ble_1(){
				$ID("data_ble").innerHTML = "Scanning Using BLE Bluetooth"
				$ID('data_blelogs').innerHTML = "Logging"
				try{
					ble.scan([],3, function(device) {
						// $ID("data_ble").innerHTML = JSON.stringify(device)
						coords.push({"id":device['id'],"distance" : getDistance(device['rssi']).toFixed(2)})
						$ID("data_ble").innerHTML = $ID("data_ble").innerHTML + card_create_single(device)
						dom_refresh()
					}, function(){
						$ID("data_ble").innerHTML = "<b class='x-text-red x-large'>Failed in Scanning using <i></i></b>"
					});
				}catch(e){
					$ID("data_ble").innerHTML = "<b class='x-text-red x-large'>An error has been detecting while scanning<i></i></b>"
					$ID('data_blelogs').innerText = e
				}
			}

			function getDistance(rssi){
				let n=2;let mp=-69
				return 10 ** ((mp - (rssi))/(10 * n))
			}

			function get_coords(){
				for (var i = 0; i < coords.length; i++) {
					try{
						var distances_ = [
							coords[i+2]['distance'].toFixed(2),
							coords[i+1]['distance'].toFixed(2),
							coords[i+0]['distance'].toFixed(2)]; // Replace with your actual distances
							$ID("error_").innerHTML = $ID("error_").innerHTML + get_item_coordinates(distances_)
						coords[i]['coords'] = get_item_coordinates(distances_)
					}catch(e){
						coords[i]['coords'] =[
							parseFloat(getRandomFloat(1.5, 3.5, 4)+ "0009").toFixed(7),
							parseFloat(getRandomFloat(1.5, 3.5, 4)+ "0009").toFixed(7)
							]

						$ID("error_").innerHTML += i+" :"+ e +"<br>"
					}
				}
				$ID('data_blelogs').innerHTML = JSON.stringify(coords)
				mark_on_map(coords)
			}

			function mark_on_map(ar_latlng){
				var distance_tolerance = 0.000011
				try{
					get_loccation(function(latlng){
						for (var i = 0; i < ar_latlng.length; i++) {
							var lat = ((ar_latlng[i]['coords'][0]*distance_tolerance)+latlng[0]).toFixed(7)
							var long = ((ar_latlng[i]['coords'][1]*distance_tolerance)+latlng[1]).toFixed(7)
							var mlatlng = [lat,long];
							$ID("activity_log").innerHTML =$ID("activity_log").innerHTML + "Marker set to: "+mlatlng +"<br>"
							L.marker(mlatlng, {icon: beacon_icon}).addTo(map)
						}
					})
				}catch(e){
					$ID("error_").innerHTML = $ID("error_").innerHTML + "latlng : "+e
				}
				// .bindPopup("You are within " + radius + " meters from this point").openPopup();
			}

			var create_icon_marker = L.Icon.extend({
				options: {
					iconSize:     [20, 20],
				}
			});
			var beacon_icon = new create_icon_marker({iconUrl: 'img/beacon.png'})

			function getRandomFloat(min, max, decimals) {
				const str = (Math.random() * (max - min) + min).toFixed(
				decimals,
				);
				return parseFloat(str);
			}

			function card_create_single(device){
				var bg_color = "x-pale-blue"
				if(device['name']==undefined || device['name']=="undefined"){
					bg_color = "x-pale-yellow"
				}
				var c_holder = (`
					<div id='`+device['id']+`' class="`+bg_color+` x-hover-black x-container x-padding x-border-dashed" onclick="get_rssi_info('`+device['id']+`')">
						<span class="x-text-grey">ID/Name : </span><b id="class_id" class="">`+device['id']+` | `+device['name']+`</b> 
						<span class="x-text-grey">Connectable : </span><b id="conn" class="">`+device['connectable']+`</b><br>
						
						<span class="x-text-grey">RSSI : </span><b id="conn" class="">`+device['rssi']+`</b> | 
						<span class="x-text-grey">Approx Distance : 
							</span><b id="conn" class="">`+
							getDistance(device['rssi']).toFixed(2)
							+`meters</b> | 
						<span class="x-text-grey">Advert/Broadcast : </span><b id="advert" class="">`+JSON.stringify
						(device['advertising'])+`</b><br>
					</div>
				`)
				// $ID('data_blelogs').innerText = c_holder
				return c_holder
				// return device
			}

			function get_rssi_info(device_id){
				$ID("data_ble").innerHTML ="<b class='x-text-yellow x-large'>Please Wait while we load the data</b>"
				ble.connect(device_id,
				function(res){
					$ID("data_ble").innerHTML ="<code>"+JSON.stringify(res)+"</code>"
				}, function(){
					$ID("data_ble").innerHTML ="<b class='x-text-red x-large'>Connection was cut-off before making a communication</b>"
				});
			}

			
			window.setInterval(get_status,1000)
			function get_status(){
				$send({
					action : DOMAIN+"/status",
					mdethod : POST,
					func : function(r){
						var res = JSON.parse(r)
						var btns = $CLASS('floors')
						for (var i = 0; i < btns.length; i++) {
							try{
								btns[i].classList.remove("x-orange");
								btns[i].classList.remove("x-green");
								btns[i].classList.add("x-orange");
							}catch(e){
								// println(e)
							}
						}

						for (var i = 0; i < res.length; i++) {
							// println($ID(res[i]))
							try{
								$ID(res[i]).classList.remove("x-green");
								btns[i].classList.remove("x-orange");

								$ID(res[i]).classList.add("x-green");
							}catch(e){
								// println(e)
							}
						}
					},
					// err_dialog : true
				})
			}

			var f1_points = [[-3.258166272269781,7.62110608141114],[-1.8251446584904607,4.893084211021239],[0.8365388432728298,4.998055141918801],[4.4941700648727165,4.747274116906838],[6.589395908922775,4.745633738158085],[4.359753848052996,7.009097351484162],[7.794734252371367,5.530498130964125],[0.6192379809346127,5.8803929892666],[-0.567457176381428,5.51027886528477],[9.14447106523277,4.5825663966471435],[9.16331481823188,6.247098243923473],[4.443406524566357,6.385676805482522],[9.00309112234429,3.8994268833571257],[9.011134760775736,2.882074772609637],[8.956247132191919,2.3679712575990424],[9.003899628253379,1.194785636117745],[9.120667079726811,0.8205499241080552],[9.647494423540596,-0.5230667796407951],[9.647494423540596,-0.5230667796407951],[9.184263960622006,-0.8531932097054935],[9.05134078902553,-1.4400789839790191],[9.006515888778045,-2.453771948983352],[8.5822955976287,-3.518375712823484],[12.080114698766764,-1.9179805057476313],[12.177307828145974,-5.570540142281957],[9.264303050934103,-4.8140566210030356],[7.819098220832069,-4.407309987566572],[4.146250129083232,-4.347162020003573],[-0.18372682799099582,-4.198182770484003],[-3.3291714643897645,-4.419699215022045],[-6.457077671225951,-4.438476228885537],[-8.841611682559632,-4.383578657144001],[-9.00858203304276,-3.0858395683418682],[-9.17555238352589,-1.788100479539735],[-9.263902125883215,-1.1483751854881123],[-8.754864502330356,0.7140002930244027],[-9.100596625149574,2.5597311722864577],[-8.769564100374009,4.935022750574822],[-8.791115626453076,6.346917085759711],[-10.423950934491431,6.770772666378329],[-6.6032266716382155,5.519424196989007],[-6.9819318749266115,6.277912257482661],[-6.804867646076419,6.930777300576819]]
		</script>
	</body>
</html>

